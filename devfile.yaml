schemaVersion: 2.2.0
metadata:
  name: vr-development
components:
  - name: tools
    container:
      image:  registry.redhat.io/devspaces/udi-rhel8:3.15-5
      memoryLimit: 1512Mi
      mountSources: true
      volumeMounts:
        - name: m2
          path: /home/user/.m2
      env:
        - name: JAVA_OPTS
          value: '-Djava.security.egd=file:/dev/urandom -Djboss.host.name=localhost'
        - name: DEBUG_PORT
          value: '5005'
        - name: NODE_NAME
          value: '{{nodeName}}'
        - name: IMAGE
          value: '{{imageName}}'
      endpoints:
        - name: debug
          exposure: internal
          protocol: tcp
          targetPort: 5005
        - name: 'http'
          protocol: https
          targetPort: 8080
          exposure: public
        - name: 'management'
          targetPort: 9990
          protocol: http
          exposure: internal
  - name: db
    container:
      image:  registry.redhat.io/rhel9/postgresql-13:1-193
      memoryLimit: 1512Mi      
      env:
        - name: POSTGRESQL_USER
          value: user
        - name: POSTGRESQL_PASSWORD
          value: pass
        - name: POSTGRESQL_DATABASE
          value: pgdb
      # endpoints:
      #   - name: postgres
      #     targetPort: 5432
      #     exposure: public
  - name: pgadmin
    container:
      image:  dpage/pgadmin4:latest
  - name: wiremock
    container:
      image:  wiremock/wiremock:latest
  - name: m2
    volume:
      size: 3Gi
commands:
  - id: package
    exec:
      label: "01 - Build the application."
      component: tools
      commandLine: mvn clean verify
      workingDir: ${PROJECT_SOURCE}
      hotReloadCapable: true
      group:
        kind: build
        isDefault: true
  - id: run
    exec:
      label: "02 - Run the application in dev mode."
      component: tools
      commandLine: mvn -Dwildfly.javaOpts="-Djboss.host.name=${NODE_NAME}" -Dmaven.test.skip=true clean package org.wildfly.plugins:wildfly-maven-plugin:dev
      workingDir: ${PROJECT_SOURCE}
      hotReloadCapable: true
      group:
        kind: run
        isDefault: true
  - id: debug
    exec:
      label: "03 - Debug the application in dev mode."
      component: tools
      commandLine: mvn -Dwildfly.javaOpts="-Djboss.host.name=${NODE_NAME} -agentlib:jdwp=transport=dt_socket,address=*:5005,server=y,suspend=n" -Dmaven.test.skip=true clean package org.wildfly.plugins:wildfly-maven-plugin:dev
      workingDir: ${PROJECT_SOURCE}
      hotReloadCapable: true
      group:
        kind: debug
        isDefault: true
